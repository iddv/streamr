name: Deploy StreamrP2P Infrastructure

on:
  push:
    branches: [ main ]
    paths:
      - 'infrastructure/**'
      - 'coordinator/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'infrastructure/**'
      - 'coordinator/**'
  workflow_dispatch:
    inputs:
      stage:
        description: 'Deployment stage'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - prod

env:
  AWS_REGION: eu-west-1
  CDK_DEFAULT_REGION: eu-west-1

# These permissions are needed to interact with GitHub's OIDC Token endpoint
permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Debug Environment
        run: |
          echo "ğŸ” Debug Information:"
          echo "Stage: ${{ github.event.inputs.stage || 'beta' }}"
          echo "AWS Region: ${{ env.AWS_REGION }}"
          echo "Beta Account ID: ${{ vars.AWS_ACCOUNT_ID_BETA }}"
          echo "Prod Account ID: ${{ vars.AWS_ACCOUNT_ID_PROD }}"
          echo "GitHub Run ID: ${{ github.run_id }}"
          echo "GitHub Ref: ${{ github.ref }}"

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID_BETA }}:role/streamr-github-actions-role
          role-session-name: streamr-github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
        if: github.event.inputs.stage == 'beta' || github.event.inputs.stage == ''

      - name: Configure AWS credentials for Production
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID_PROD }}:role/streamr-github-actions-role
          role-session-name: streamr-github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
        if: github.event.inputs.stage == 'prod'

      - name: Install CDK dependencies
        working-directory: infrastructure
        run: npm ci

      - name: Build CDK app
        working-directory: infrastructure
        run: npm run build

      - name: Run CDK tests
        working-directory: infrastructure
        run: npm test

      - name: Deploy GitHub OIDC Stack (if needed)
        working-directory: infrastructure
        run: |
          # Check if OIDC stack exists, deploy if not
          STAGE=${{ github.event.inputs.stage || 'beta' }}
          OIDC_STACK_NAME="streamr-p2p-$STAGE-ireland-github-oidc"
          if ! aws cloudformation describe-stacks --stack-name "$OIDC_STACK_NAME" 2>/dev/null; then
            echo "ğŸ” Deploying GitHub OIDC stack: $OIDC_STACK_NAME"
            npx cdk deploy "$OIDC_STACK_NAME" --require-approval never
          else
            echo "âœ… GitHub OIDC stack already exists: $OIDC_STACK_NAME"
          fi

      - name: Deploy Foundation Stack
        working-directory: infrastructure
        run: |
          STAGE=${{ github.event.inputs.stage || 'beta' }}
          FOUNDATION_STACK_NAME="streamr-p2p-$STAGE-ireland-foundation"
          echo "ğŸ—ï¸ Deploying foundation stack: $FOUNDATION_STACK_NAME"
          npx cdk deploy "$FOUNDATION_STACK_NAME" --require-approval never --context stage=$STAGE

      - name: Deploy Application Stack
        working-directory: infrastructure
        run: |
          STAGE=${{ github.event.inputs.stage || 'beta' }}
          APPLICATION_STACK_NAME="streamr-p2p-$STAGE-ireland-application"
          echo "ğŸš€ Deploying application stack: $APPLICATION_STACK_NAME"
          npx cdk deploy "$APPLICATION_STACK_NAME" --require-approval never --context stage=$STAGE

      - name: Output deployment info
        working-directory: infrastructure
        run: |
          STAGE=${{ github.event.inputs.stage || 'beta' }}
          APPLICATION_STACK_NAME="streamr-p2p-$STAGE-ireland-application"
          echo "ğŸ“Š Deployment completed for stage: $STAGE"
          
          # Get ALB DNS name
          ALB_DNS=$(aws cloudformation describe-stacks \
            --stack-name "$APPLICATION_STACK_NAME" \
            --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerDNS`].OutputValue' \
            --output text)
          
          echo "ğŸŒ Application Load Balancer: $ALB_DNS"
          echo "ğŸ¬ RTMP Ingest: rtmp://$ALB_DNS:1935/live/"
          echo "ğŸ“º HLS Playback: http://$ALB_DNS:8085/live/"
          echo "ğŸ“Š Dashboard: http://$ALB_DNS/dashboard"
          echo "ğŸ† Leaderboard: http://$ALB_DNS/leaderboard"
          echo "ğŸ’° Payouts: http://$ALB_DNS/payouts"

  post-deploy-tests:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID_BETA }}:role/streamr-github-actions-role
          role-session-name: streamr-post-deploy-tests-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
        if: github.event.inputs.stage == 'beta' || github.event.inputs.stage == ''

      - name: Configure AWS credentials for Production
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID_PROD }}:role/streamr-github-actions-role
          role-session-name: streamr-post-deploy-tests-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
        if: github.event.inputs.stage == 'prod'

      - name: Run sanity tests
        working-directory: infrastructure
        run: |
          STAGE=${{ github.event.inputs.stage || 'beta' }}
          APPLICATION_STACK_NAME="streamr-p2p-$STAGE-ireland-application"
          echo "ğŸ§ª Running sanity tests for stage: $STAGE"
          echo "ğŸ“‹ Stack name: $APPLICATION_STACK_NAME"
          
          # Debug: List all stacks to see what exists
          echo "ğŸ” Available CloudFormation stacks:"
          aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE --query 'StackSummaries[].StackName' --output table
          
          # Get ALB DNS name with debugging
          echo "ğŸ” Getting ALB DNS name from stack outputs..."
          ALB_DNS=$(aws cloudformation describe-stacks \
            --stack-name "$APPLICATION_STACK_NAME" \
            --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerDNS`].OutputValue' \
            --output text 2>/dev/null || echo "")
          
          echo "ğŸŒ ALB DNS: '$ALB_DNS'"
          
          if [ -z "$ALB_DNS" ] || [ "$ALB_DNS" = "None" ]; then
            echo "âŒ ALB DNS name not found. Checking all stack outputs:"
            aws cloudformation describe-stacks --stack-name "$APPLICATION_STACK_NAME" --query 'Stacks[0].Outputs' --output table || echo "Stack not found"
            exit 1
          fi
          
          # Test health endpoint
          echo "ğŸ” Testing health endpoint: http://$ALB_DNS/health"
          if curl -f --connect-timeout 30 --max-time 60 "http://$ALB_DNS/health"; then
            echo "âœ… Health endpoint responded"
          else
            echo "âŒ Health endpoint failed"
            echo "ğŸ” Trying to get more info about the ALB..."
            curl -v "http://$ALB_DNS/health" || true
            exit 1
          fi
          
          # Test dashboard endpoint  
          echo "ğŸ” Testing dashboard endpoint: http://$ALB_DNS/dashboard"
          if curl -f --connect-timeout 30 --max-time 60 "http://$ALB_DNS/dashboard"; then
            echo "âœ… Dashboard endpoint responded"
          else
            echo "âŒ Dashboard endpoint failed"
            echo "ğŸ” Trying to get more info about the ALB..."
            curl -v "http://$ALB_DNS/dashboard" || true
            exit 1
          fi
          
          echo "âœ… All sanity tests passed!" 